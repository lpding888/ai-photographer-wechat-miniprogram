<!--é€ å‹å›å¿†-->
<view class="memories-container">
  <!-- é¡¶éƒ¨ç­›é€‰ -->
  <view class="filter-bar">
    <scroll-view class="filter-scroll" scroll-x>
      <view class="filter-list">
        <view
          class="filter-item {{selectedFilter === item.key ? 'active' : ''}}"
          wx:for="{{filterOptions}}"
          wx:key="key"
          bindtap="onFilterChange"
          data-filter="{{item.key}}"
        >
          <text>{{item.label}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ—¶é—´è½´åˆ—è¡¨ -->
  <scroll-view class="timeline-scroll" scroll-y>
    <view class="timeline-container" wx:if="{{memories.length > 0}}">
      <view
        class="memory-item"
        wx:for="{{memories}}"
        wx:key="id"
        bindtap="onMemoryClick"
        data-id="{{item.id}}"
        bindlongpress="onMemoryLongPress"
      >
        <!-- æ—¶é—´è½´çº¿ -->
        <view class="timeline-line"></view>
        <view class="timeline-dot"></view>

        <!-- å›å¿†å¡ç‰‡ -->
        <view class="memory-card">
          <!-- æ—¥æœŸæ ‡ç­¾ -->
          <view class="memory-date">
            <text class="date-day">{{item.displayDay}}</text>
            <text class="date-month">{{item.displayMonth}}</text>
          </view>

          <!-- å›¾ç‰‡å±•ç¤º -->
          <view class="memory-images" wx:if="{{item.images && item.images.length > 0}}">
            <image
              class="memory-image {{item.images.length === 1 ? 'single' : ''}}"
              wx:for="{{item.images}}"
              wx:key="*this"
              wx:for-item="img"
              src="{{img}}"
              mode="{{item.images.length === 1 ? 'aspectFill' : 'aspectFill'}}"
              bindtap="onImageClick"
              data-images="{{item.images}}"
              data-index="{{index}}"
              catchtap="stopPropagation"
            ></image>
          </view>

          <!-- å›å¿†å†…å®¹ -->
          <view class="memory-content">
            <!-- æ ‡é¢˜ -->
            <view class="memory-title" wx:if="{{item.title}}">{{item.title}}</view>

            <!-- å¤‡æ³¨ -->
            <view class="memory-note" wx:if="{{item.note}}">{{item.note}}</view>

            <!-- å¿ƒæƒ… -->
            <view class="memory-mood" wx:if="{{item.mood}}">
              <text class="mood-icon">{{item.moodIcon}}</text>
              <text class="mood-text">{{item.moodText}}</text>
            </view>

            <!-- å…³è”çš„è¡£ç‰© -->
            <view class="memory-outfit" wx:if="{{item.items && item.items.length > 0}}">
              <view class="outfit-label">ç©¿æ­</view>
              <view class="outfit-items">
                <image
                  class="outfit-item"
                  wx:for="{{item.items}}"
                  wx:key="id"
                  wx:for-item="outfit"
                  src="{{outfit.processedImage || outfit.url}}"
                  mode="aspectFit"
                ></image>
              </view>
            </view>

            <!-- æ—¶é—´å’Œåœ°ç‚¹ -->
            <view class="memory-meta">
              <text class="meta-time">{{item.displayTime}}</text>
              <text class="meta-location" wx:if="{{item.location}}">ğŸ“ {{item.location}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{memories.length === 0 && !loading}}">
      <view class="empty-icon">ğŸ“¸</view>
      <text class="empty-title">æš‚æ— å›å¿†</text>
      <text class="empty-hint">è®°å½•æ¯ä¸€æ¬¡ç²¾å½©æ—¶åˆ»</text>
    </view>
  </scroll-view>

  <!-- æ‚¬æµ®æ·»åŠ æŒ‰é’® -->
  <view class="fab" bindtap="onAddMemory">
    <text class="fab-icon">+</text>
  </view>
</view>

<!-- æ·»åŠ å›å¿†å¼¹çª— -->
<view class="add-modal {{showAddModal ? 'show' : ''}}" catchtap="onCloseAddModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">{{isEditMode ? 'ç¼–è¾‘' : 'æ·»åŠ '}}å›å¿†</text>
      <view class="modal-close" bindtap="onCloseAddModal">Ã—</view>
    </view>

    <scroll-view class="modal-body" scroll-y>
      <!-- æ—¥æœŸ -->
      <view class="form-item">
        <text class="form-label">æ—¥æœŸ</text>
        <picker mode="date" value="{{memoryForm.date}}" bindchange="onDateChange">
          <view class="picker-value">{{memoryForm.date}}</view>
        </picker>
      </view>

      <!-- æ—¶é—´ -->
      <view class="form-item">
        <text class="form-label">æ—¶é—´</text>
        <picker mode="time" value="{{memoryForm.time}}" bindchange="onTimeChange">
          <view class="picker-value">{{memoryForm.time}}</view>
        </picker>
      </view>

      <!-- æ ‡é¢˜ -->
      <view class="form-item">
        <text class="form-label">æ ‡é¢˜</text>
        <input
          class="form-input"
          placeholder="ç»™è¿™ä¸ªå›å¿†èµ·ä¸ªæ ‡é¢˜"
          value="{{memoryForm.title}}"
          bindinput="onTitleInput"
        />
      </view>

      <!-- ç…§ç‰‡ -->
      <view class="form-item">
        <text class="form-label">ç…§ç‰‡</text>
        <view class="image-uploader">
          <view class="uploaded-images" wx:if="{{memoryForm.images.length > 0}}">
            <view
              class="uploaded-item"
              wx:for="{{memoryForm.images}}"
              wx:key="*this"
            >
              <image class="uploaded-image" src="{{item}}" mode="aspectFill"></image>
              <view class="remove-btn" bindtap="onRemoveImage" data-index="{{index}}">Ã—</view>
            </view>
          </view>
          <view class="upload-btn" bindtap="onChooseImage" wx:if="{{memoryForm.images.length < 9}}">
            <text class="upload-icon">+</text>
            <text class="upload-text">æ·»åŠ ç…§ç‰‡</text>
          </view>
        </view>
      </view>

      <!-- å¿ƒæƒ… -->
      <view class="form-item">
        <text class="form-label">å¿ƒæƒ…</text>
        <view class="mood-buttons">
          <view
            class="mood-btn {{memoryForm.mood === item.key ? 'active' : ''}}"
            wx:for="{{moodOptions}}"
            wx:key="key"
            bindtap="onSelectMood"
            data-mood="{{item.key}}"
          >
            <text class="mood-emoji">{{item.icon}}</text>
            <text class="mood-label">{{item.label}}</text>
          </view>
        </view>
      </view>

      <!-- å…³è”è¡£ç‰© -->
      <view class="form-item">
        <text class="form-label">ç©¿æ­è®°å½•</text>
        <view class="outfit-selector" bindtap="onSelectOutfit">
          <view class="selected-outfit" wx:if="{{memoryForm.items.length > 0}}">
            <view class="outfit-previews">
              <image
                class="outfit-preview"
                wx:for="{{memoryForm.items}}"
                wx:key="id"
                src="{{item.processedImage || item.url}}"
                mode="aspectFit"
              ></image>
            </view>
            <text class="change-text">æ›´æ”¹</text>
          </view>
          <view class="no-outfit" wx:else>
            <text class="add-icon">+</text>
            <text>é€‰æ‹©è¡£ç‰©</text>
          </view>
        </view>
      </view>

      <!-- åœ°ç‚¹ -->
      <view class="form-item">
        <text class="form-label">åœ°ç‚¹</text>
        <input
          class="form-input"
          placeholder="åœ¨å“ªé‡Œåº¦è¿‡çš„ï¼Ÿ"
          value="{{memoryForm.location}}"
          bindinput="onLocationInput"
        />
      </view>

      <!-- å¤‡æ³¨ -->
      <view class="form-item">
        <text class="form-label">å¤‡æ³¨</text>
        <textarea
          class="form-textarea"
          placeholder="è®°å½•å½“æ—¶çš„å¿ƒæƒ…å’Œæ•…äº‹..."
          value="{{memoryForm.note}}"
          bindinput="onNoteInput"
          maxlength="500"
        ></textarea>
      </view>
    </scroll-view>

    <view class="modal-footer">
      <button class="btn-cancel" bindtap="onCloseAddModal">å–æ¶ˆ</button>
      <button class="btn-save" bindtap="onSaveMemory">ä¿å­˜</button>
    </view>
  </view>
</view>

<!-- è¡£ç‰©é€‰æ‹©å¼¹çª—ï¼ˆå¤ç”¨ï¼‰ -->
<view class="outfit-modal {{showOutfitModal ? 'show' : ''}}" catchtap="onCloseOutfitModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©è¡£ç‰©</text>
      <view class="modal-close" bindtap="onCloseOutfitModal">Ã—</view>
    </view>

    <!-- åˆ†ç±»ç­›é€‰ -->
    <scroll-view class="category-scroll" scroll-x>
      <view class="category-list">
        <view
          class="category-item {{selectedCategory === item.key ? 'active' : ''}}"
          wx:for="{{categories}}"
          wx:key="key"
          bindtap="onCategoryChange"
          data-category="{{item.key}}"
        >
          <text class="category-icon">{{item.icon}}</text>
          <text class="category-name">{{item.label}}</text>
        </view>
      </view>
    </scroll-view>

    <!-- è¡£ç‰©åˆ—è¡¨ -->
    <scroll-view class="items-scroll" scroll-y>
      <view class="items-grid">
        <view
          class="item-card {{item.selected ? 'selected' : ''}}"
          wx:for="{{wardrobeItems}}"
          wx:key="id"
          bindtap="onToggleItem"
          data-id="{{item.id}}"
        >
          <image
            class="item-image"
            src="{{item.processedImage || item.url}}"
            mode="aspectFit"
          ></image>
          <view class="item-name">{{item.name}}</view>
          <view class="item-check" wx:if="{{item.selected}}">âœ“</view>
        </view>
      </view>
    </scroll-view>

    <view class="modal-footer">
      <view class="selected-count">å·²é€‰æ‹© {{selectedItemsCount}} ä»¶</view>
      <button class="btn-confirm" bindtap="onConfirmOutfit">ç¡®å®š</button>
    </view>
  </view>
</view>
