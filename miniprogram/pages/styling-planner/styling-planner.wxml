<!--é€ å‹è§„åˆ’å™¨-->
<view class="planner-container">
  <!-- é¡¶éƒ¨æœˆä»½åˆ‡æ¢ -->
  <view class="month-header">
    <view class="month-nav" bindtap="onPrevMonth">
      <text class="nav-icon">â€¹</text>
    </view>
    <view class="month-title">
      <text class="year">{{currentYear}}å¹´</text>
      <text class="month">{{currentMonth}}æœˆ</text>
    </view>
    <view class="month-nav" bindtap="onNextMonth">
      <text class="nav-icon">â€º</text>
    </view>
  </view>

  <!-- æ˜ŸæœŸæ ‡é¢˜ -->
  <view class="week-header">
    <view class="week-day" wx:for="{{weekDays}}" wx:key="*this">
      <text>{{item}}</text>
    </view>
  </view>

  <!-- æ—¥å†ç½‘æ ¼ -->
  <scroll-view class="calendar-scroll" scroll-y>
    <view class="calendar-grid">
      <view
        class="date-cell {{item.isToday ? 'today' : ''}} {{item.isOtherMonth ? 'other-month' : ''}} {{item.hasEvent ? 'has-event' : ''}}"
        wx:for="{{calendarDays}}"
        wx:key="id"
        bindtap="onDateClick"
        data-date="{{item.date}}"
      >
        <!-- æ—¥æœŸæ•°å­— -->
        <view class="date-number">{{item.day}}</view>

        <!-- äº‹ä»¶æ ‡è®°ç‚¹ -->
        <view class="event-dots" wx:if="{{item.hasEvent && !item.isOtherMonth}}">
          <view class="dot" wx:for="{{item.events}}" wx:key="id" wx:for-item="evt" style="background: {{evt.color}}"></view>
        </view>

        <!-- é€ å‹ç¼©ç•¥å›¾ -->
        <view class="outfit-preview" wx:if="{{item.outfitImage && !item.isOtherMonth}}">
          <image class="outfit-thumb" src="{{item.outfitImage}}" mode="aspectFill"></image>
        </view>

        <!-- å¤©æ°”å›¾æ ‡ï¼ˆæœªæ¥7å¤©ï¼‰ -->
        <view class="weather-icon" wx:if="{{item.weather && !item.isOtherMonth}}">
          <text>{{item.weather}}</text>
        </view>
      </view>
    </view>

    <!-- äº‹ä»¶åˆ—è¡¨ -->
    <view class="events-section" wx:if="{{todayEvents.length > 0}}">
      <view class="section-title">
        <text>ä»Šæ—¥å®‰æ’</text>
      </view>
      <view class="event-list">
        <view
          class="event-item"
          wx:for="{{todayEvents}}"
          wx:key="id"
          bindtap="onEventClick"
          data-id="{{item.id}}"
        >
          <view class="event-color" style="background: {{item.color}}"></view>
          <view class="event-content">
            <view class="event-title">{{item.title}}</view>
            <view class="event-meta">
              <text class="event-type">{{item.typeName}}</text>
              <text class="event-time">{{item.time}}</text>
            </view>
          </view>
          <view class="event-outfit" wx:if="{{item.outfitImage}}">
            <image class="outfit-mini" src="{{item.outfitImage}}" mode="aspectFill"></image>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{todayEvents.length === 0}}">
      <view class="empty-icon">ğŸ“…</view>
      <text class="empty-title">æš‚æ— å®‰æ’</text>
      <text class="empty-hint">ç‚¹å‡»æ—¥æœŸåˆ›å»ºäº‹ä»¶è§„åˆ’</text>
    </view>
  </scroll-view>

  <!-- æ‚¬æµ®æ·»åŠ æŒ‰é’® -->
  <view class="fab" bindtap="onAddEvent">
    <text class="fab-icon">+</text>
  </view>
</view>

<!-- äº‹ä»¶è§„åˆ’å¼¹çª— -->
<view class="event-modal {{showEventModal ? 'show' : ''}}" catchtap="onCloseEventModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">{{isEditMode ? 'ç¼–è¾‘' : 'åˆ›å»º'}}äº‹ä»¶</text>
      <view class="modal-close" bindtap="onCloseEventModal">Ã—</view>
    </view>

    <view class="modal-body">
      <!-- æ—¥æœŸ -->
      <view class="form-item">
        <text class="form-label">æ—¥æœŸ</text>
        <picker mode="date" value="{{eventForm.date}}" bindchange="onDateChange">
          <view class="picker-value">{{eventForm.date}}</view>
        </picker>
      </view>

      <!-- æ—¶é—´ -->
      <view class="form-item">
        <text class="form-label">æ—¶é—´</text>
        <picker mode="time" value="{{eventForm.time}}" bindchange="onTimeChange">
          <view class="picker-value">{{eventForm.time}}</view>
        </picker>
      </view>

      <!-- æ ‡é¢˜ -->
      <view class="form-item">
        <text class="form-label">æ ‡é¢˜</text>
        <input
          class="form-input"
          placeholder="è¾“å…¥äº‹ä»¶æ ‡é¢˜"
          value="{{eventForm.title}}"
          bindinput="onTitleInput"
        />
      </view>

      <!-- ç±»å‹ -->
      <view class="form-item">
        <text class="form-label">ç±»å‹</text>
        <view class="type-buttons">
          <view
            class="type-btn {{eventForm.type === item.key ? 'active' : ''}}"
            wx:for="{{eventTypes}}"
            wx:key="key"
            bindtap="onSelectType"
            data-type="{{item.key}}"
          >
            <text class="type-icon">{{item.icon}}</text>
            <text class="type-name">{{item.label}}</text>
          </view>
        </view>
      </view>

      <!-- å¤©æ°” -->
      <view class="form-item">
        <text class="form-label">å¤©æ°”</text>
        <view class="weather-buttons">
          <view
            class="weather-btn {{eventForm.weather === item.key ? 'active' : ''}}"
            wx:for="{{weatherOptions}}"
            wx:key="key"
            bindtap="onSelectWeather"
            data-weather="{{item.key}}"
          >
            <text>{{item.icon}}</text>
          </view>
        </view>
      </view>

      <!-- é€‰æ‹©é€ å‹æŒ‰é’® -->
      <view class="form-item">
        <view class="form-label-row">
          <text class="form-label">é€ å‹æ­é…</text>
          <view class="ai-suggest-btn" bindtap="onGetAISuggestion">
            <text class="ai-icon">ğŸ¤–</text>
            <text class="ai-text">AIå»ºè®®</text>
          </view>
        </view>
        <view class="outfit-selector" bindtap="onSelectOutfit">
          <view class="selected-outfit" wx:if="{{eventForm.selectedItems.length > 0}}">
            <view class="outfit-items">
              <image
                class="outfit-item-img"
                wx:for="{{eventForm.selectedItems}}"
                wx:key="id"
                src="{{item.processedImage || item.url}}"
                mode="aspectFit"
              ></image>
            </view>
            <text class="change-text">æ›´æ”¹</text>
          </view>
          <view class="no-outfit" wx:else>
            <text class="add-icon">+</text>
            <text>é€‰æ‹©è¡£ç‰©</text>
          </view>
        </view>
      </view>

      <!-- å¤‡æ³¨ -->
      <view class="form-item">
        <text class="form-label">å¤‡æ³¨</text>
        <textarea
          class="form-textarea"
          placeholder="æ·»åŠ å¤‡æ³¨ä¿¡æ¯"
          value="{{eventForm.note}}"
          bindinput="onNoteInput"
          maxlength="200"
        ></textarea>
      </view>
    </view>

    <view class="modal-footer">
      <button class="btn-cancel" bindtap="onCloseEventModal">å–æ¶ˆ</button>
      <button class="btn-save" bindtap="onSaveEvent">ä¿å­˜</button>
    </view>
  </view>
</view>

<!-- é€‰æ‹©è¡£ç‰©å¼¹çª— -->
<view class="outfit-modal {{showOutfitModal ? 'show' : ''}}" catchtap="onCloseOutfitModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©è¡£ç‰©</text>
      <view class="modal-close" bindtap="onCloseOutfitModal">Ã—</view>
    </view>

    <!-- åˆ†ç±»ç­›é€‰ -->
    <scroll-view class="category-scroll" scroll-x>
      <view class="category-list">
        <view
          class="category-item {{selectedCategory === item.key ? 'active' : ''}}"
          wx:for="{{categories}}"
          wx:key="key"
          bindtap="onCategoryChange"
          data-category="{{item.key}}"
        >
          <text class="category-icon">{{item.icon}}</text>
          <text class="category-name">{{item.label}}</text>
        </view>
      </view>
    </scroll-view>

    <!-- è¡£ç‰©åˆ—è¡¨ -->
    <scroll-view class="items-scroll" scroll-y>
      <view class="items-grid">
        <view
          class="item-card {{item.selected ? 'selected' : ''}}"
          wx:for="{{wardrobeItems}}"
          wx:key="id"
          bindtap="onToggleItem"
          data-id="{{item.id}}"
        >
          <image
            class="item-image"
            src="{{item.processedImage || item.url}}"
            mode="aspectFit"
          ></image>
          <view class="item-name">{{item.name}}</view>
          <view class="item-check" wx:if="{{item.selected}}">âœ“</view>
        </view>
      </view>

      <view class="empty-wardrobe" wx:if="{{wardrobeItems.length === 0}}">
        <text class="empty-icon">ğŸ‘”</text>
        <text class="empty-text">è¡£æŸœç©ºç©ºå¦‚ä¹Ÿ</text>
        <text class="empty-hint">å»æ·»åŠ è¡£ç‰©å§</text>
      </view>
    </scroll-view>

    <view class="modal-footer">
      <view class="selected-count">å·²é€‰æ‹© {{selectedItemsCount}} ä»¶</view>
      <button class="btn-confirm" bindtap="onConfirmOutfit">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- AIå»ºè®®å¼¹çª— -->
<view class="ai-modal {{showAIModal ? 'show' : ''}}" catchtap="onCloseAIModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">ğŸ¤– AIé€ å‹å¸ˆå»ºè®®</text>
      <view class="modal-close" bindtap="onCloseAIModal">Ã—</view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="ai-loading" wx:if="{{aiLoading}}">
      <view class="loading-icon">ğŸ¤”</view>
      <text class="loading-text">AIæ­£åœ¨åˆ†ææ‚¨çš„è¡£æŸœ...</text>
      <view class="loading-spinner"></view>
    </view>

    <!-- AIå»ºè®®å†…å®¹ -->
    <scroll-view class="modal-body" scroll-y wx:if="{{!aiLoading && aiSuggestion}}">
      <!-- é£æ ¼æ ‡ç­¾ -->
      <view class="ai-style-tag">
        <text>{{aiSuggestion.style}}</text>
      </view>

      <!-- å»ºè®®æ–‡æ¡ˆ -->
      <view class="ai-advice">
        <text class="advice-text">{{aiSuggestion.advice}}</text>
      </view>

      <!-- æ¨èè¡£ç‰© -->
      <view class="ai-recommendations" wx:if="{{aiSuggestion.recommendedItems && aiSuggestion.recommendedItems.length > 0}}">
        <view class="recommend-title">ğŸ’ æ¨èæ­é…</view>
        <view class="recommend-items">
          <view
            class="recommend-item"
            wx:for="{{aiSuggestion.recommendedItems}}"
            wx:key="id"
          >
            <image
              class="recommend-image"
              src="{{item.processedImage || item.url}}"
              mode="aspectFit"
            ></image>
            <text class="recommend-name">{{item.name}}</text>
          </view>
        </view>
      </view>

      <!-- åŸå› è¯´æ˜ -->
      <view class="ai-reasons" wx:if="{{aiSuggestion.reasons && aiSuggestion.reasons.length > 0}}">
        <view class="reasons-title">âœ¨ æ¨èç†ç”±</view>
        <view class="reasons-list">
          <view class="reason-item" wx:for="{{aiSuggestion.reasons}}" wx:key="*this">
            <text class="reason-dot">â€¢</text>
            <text class="reason-text">{{item}}</text>
          </view>
        </view>
      </view>
    </scroll-view>

    <view class="modal-footer" wx:if="{{!aiLoading && aiSuggestion}}">
      <button class="btn-cancel" bindtap="onCloseAIModal">å–æ¶ˆ</button>
      <button class="btn-apply" bindtap="onApplyAISuggestion">é‡‡çº³å»ºè®®</button>
    </view>
  </view>
</view>
