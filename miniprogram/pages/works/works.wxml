<!--ä½œå“é¡µé¢-->
<view class="container">
  <!-- å¤šä»»åŠ¡è¿›è¡Œä¸­åˆ—è¡¨ -->
  <view wx:if="{{progressList.length > 0}}" class="progress-list">
    <block wx:for="{{progressList}}" wx:key="taskId">
      <view class="progress-card progress-card-sm">
        <view class="progress-head">
          <text class="progress-title">{{item.message || 'æ­£åœ¨ç”Ÿæˆä½œå“â€¦'}}</text>
          <text class="progress-eta">{{item.etaText}}</text>
        </view>
        <view class="progress-sub">
          <text wx:if="{{item.completed !== null && item.total !== null}}" class="progress-count">{{item.completed}} / {{item.total}}</text>
          <text wx:else class="progress-hint">é¢„è®¡çº¦10åˆ†é’Ÿå®Œæˆ</text>
        </view>
        <view class="progress-bar">
          <view class="bar-bg">
            <view class="bar-fill" style="width: {{item.percent}}%;"></view>
          </view>
          <text class="bar-percent">{{item.percent}}%</text>
        </view>
        <view class="progress-actions">
          <button class="mini-btn" size="mini" plain="true" data-task-id="{{item.taskId}}" bindtap="cancelTask">å–æ¶ˆä»»åŠ¡</button>
        </view>
      </view>
    </block>
  </view>

  <!-- è¿›è¡Œä¸­è¿›åº¦å¡ç‰‡ï¼ˆå•ä»»åŠ¡å›é€€ï¼‰ -->
  <view wx:if="{{progressList.length === 0 && progressCard.visible}}" class="progress-card">
    <view class="progress-head">
      <text class="progress-title">{{progressCard.message || 'æ­£åœ¨ç”Ÿæˆä½œå“â€¦'}}</text>
      <text class="progress-eta">{{progressCard.etaText}}</text>
    </view>
    <view class="progress-sub">
      <text wx:if="{{progressCard.completed !== null && progressCard.total !== null}}" class="progress-count">{{progressCard.completed}} / {{progressCard.total}}</text>
      <text wx:else class="progress-hint">é¢„è®¡çº¦10åˆ†é’Ÿå®Œæˆ</text>
    </view>
    <view class="progress-bar">
      <view class="bar-bg">
        <view class="bar-fill" style="width: {{progressCard.percent}}%;"></view>
      </view>
      <text class="bar-percent">{{progressCard.percent}}%</text>
    </view>
  </view>

  <!-- æ ‡ç­¾æ  -->
  <view class="tabs-container">
    <scroll-view class="tabs-scroll" scroll-x="true">
      <view class="tabs">
        <block wx:for="{{tabs}}" wx:key="key">
          <view 
            class="tab-item {{currentTab === index ? 'active' : ''}}"
            data-index="{{index}}"
            bindtap="switchTab"
          >
            <text>{{item.label}}</text>
          </view>
        </block>
      </view>
    </scroll-view>
  </view>

  <!-- ä½œå“åˆ—è¡¨ -->
  <view class="works-container">
    <!-- é¦–å±éª¨æ¶ï¼šåªåœ¨é¦–æ¬¡åŠ è½½ä¸”æš‚æ— æ•°æ®æ—¶æ˜¾ç¤º -->
    <block wx:if="{{loading && !firstLoadDone && (!works || works.length===0)}}">
      <state loading="{{true}}" skeleton="{{true}}" variant="list"></state>
    </block>
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:elif="{{isEmpty && !loading}}" class="empty-state">
      <!-- ç»Ÿä¸€çŠ¶æ€ç»„ä»¶ -->
      <state loading="{{loading}}" empty="{{isEmpty && !loading}}" emptyText="è¿˜æ²¡æœ‰æ‹æ‘„ä½œå“" tips="è®©AIæ‘„å½±å¸ˆä¸ºä½ æ‹ç¬¬ä¸€å¼ å¤§ç‰‡å§"></state>
      <button class="create-btn" bindtap="goToPhotography">å¼€å§‹æ‹æ‘„</button>
    </view>

    <!-- ä½œå“ç½‘æ ¼ï¼šå§‹ç»ˆæ˜¾ç¤ºï¼ˆæœ‰æ•°æ®æ—¶ï¼‰ -->
    <block wx:if="{{works && works.length > 0}}">
      <view class="works-grid">
      <block wx:for="{{works}}" wx:key="id">
        <view class="work-item" data-id="{{item.id}}" data-index="{{index}}" bindtap="viewWork" bindlongpress="onItemLongPress">
          <!-- ä½œå“å›¾ç‰‡ -->
          <view class="work-image">
            <image
              src="{{item.shouldLoad ? item.thumbnail : ''}}"
              mode="aspectFill"
              data-url="{{item.thumbnail}}"
              data-work-id="{{item.id}}"
              data-index="{{index}}"
              class="lazy-image {{item.shouldLoad ? 'loaded' : 'loading'}}"
              binderror="onImageError"
              bindload="onImageLoad"
            />
            <!-- æ‡’åŠ è½½å ä½ç¬¦ -->
            <view wx:if="{{!item.shouldLoad}}" class="image-placeholder">
              <view class="placeholder-icon">ğŸ“·</view>
            </view>
            
            <!-- ä½œå“ç±»å‹æ ‡ç­¾ -->
            <view class="work-type-tag">
              <text wx:if="{{item.type === 'photography'}}">æ‘„å½±</text>
              <text wx:elif="{{item.type === 'fitting'}}">æ¢è£…</text>
              <text wx:elif="{{item.type === 'fitting-personal'}}">è¯•è¡£</text>
              <text wx:elif="{{item.type === 'travel'}}">æ—…è¡Œ</text>
            </view>
            
            <!-- æ”¶è—æŒ‰é’® -->
            <view 
              class="favorite-btn {{item.is_favorite ? 'active' : ''}}"
              data-id="{{item.id}}"
              bindtap="toggleFavorite"
            >
              <text class="iconfont {{item.is_favorite ? 'icon-heart-fill' : 'icon-heart'}}"></text>
            </view>

            <!-- çŠ¶æ€å¾½æ ‡ï¼šè¿›è¡Œä¸­/å¤±è´¥ -->
            <view wx:if="{{item.status === 'processing'}}" class="status-badge status-processing">
              è¿›è¡Œä¸­
            </view>
            <view wx:if="{{item.status === 'failed'}}" class="status-badge status-failed">
              å¤±è´¥
            </view>

            <!-- æ‰¹é‡è¿›åº¦å¾½æ ‡ï¼šreceived/expected -->
            <view wx:if="{{item.batch_meta}}" class="batch-badge">
              {{item.batch_meta.batch_received}} / {{item.batch_meta.batch_expected}}
            </view>
          </view>
          
          <!-- ä½œå“ä¿¡æ¯ -->
          <view class="work-info">
            <view class="work-title">{{item.title || 'æœªå‘½åä½œå“'}}</view>
            <view class="work-desc">{{item.description_text}}</view>
            <view class="work-meta">
              <text class="work-time">{{item.display_time}}</text>
              <view class="work-actions">
                <view 
                  class="action-btn"
                  data-id="{{item.id}}"
                  bindtap="shareWork"
                >
                  <text class="iconfont icon-share"></text>
                </view>
                <view 
                  class="action-btn"
                  data-id="{{item.id}}"
                  bindtap="deleteWork"
                >
                  <text class="iconfont icon-delete"></text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>
    </view>
    </block>

    <!-- åŠ è½½æ›´å¤šï¼ˆåªåœ¨åŠ è½½æ›´å¤šæ—¶æ˜¾ç¤ºï¼Œä¸åœ¨é¦–æ¬¡åŠ è½½æ—¶æ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{loading && works.length > 0 && last_id}}" class="loading-more">
      <view class="loading-icon">
        <view class="loading-dot"></view>
        <view class="loading-dot"></view>
        <view class="loading-dot"></view>
      </view>
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view wx:if="{{!hasMore && works.length > 0}}" class="no-more">
      <text>æ²¡æœ‰æ›´å¤šä½œå“äº†</text>
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view wx:if="{{showFilterPanel}}" class="filter-panel">
    <view class="filter-mask" bindtap="hideFilter"></view>
    <view class="filter-content">
      <view class="filter-header">
        <text class="filter-title">ç­›é€‰æ¡ä»¶</text>
        <view class="filter-close" bindtap="hideFilter">
          <text class="iconfont icon-close"></text>
        </view>
      </view>
      
      <view class="filter-section">
        <text class="filter-label">æ’åºæ–¹å¼</text>
        <view class="filter-options">
          <view class="filter-option {{sortType === 'create_time' ? 'active' : ''}}" data-type="create_time" bindtap="changeSortType">
            <text>åˆ›å»ºæ—¶é—´</text>
          </view>
          <view class="filter-option {{sortType === 'favorite_time' ? 'active' : ''}}" data-type="favorite_time" bindtap="changeSortType">
            <text>æ”¶è—æ—¶é—´</text>
          </view>
        </view>
      </view>
      
      <view class="filter-actions">
        <button class="filter-reset" bindtap="resetFilter">é‡ç½®</button>
        <button class="filter-confirm" bindtap="applyFilter">ç¡®å®š</button>
      </view>
    </view>
  </view>

</view>