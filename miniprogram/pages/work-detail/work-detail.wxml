<!--ä½œå“è¯¦æƒ…é¡µé¢ - ç°ä»£åŒ–è®¾è®¡-->
<view class="container page-fade-in">
  <!-- åŠ è½½çŠ¶æ€ -->
  <block wx:if="{{loading}}">
    <state loading="{{true}}" empty="{{false}}" errorText="" skeleton="{{true}}" variant="detail"></state>
  </block>

  <block wx:else>
    <!-- å›¾ç‰‡å±•ç¤ºåŒºåŸŸ -->
    <view class="hero-section">
      <swiper
        class="hero-swiper"
        indicator-dots="{{work.images.length > 1}}"
        indicator-color="rgba(255,255,255,0.4)"
        indicator-active-color="#4A90E2"
        circular="{{work.images.length > 1}}"
        bindchange="onImageChange"
      >
        <block wx:for="{{work.images}}" wx:key="index">
          <swiper-item>
            <image
              src="{{item.temp_url || item.url}}"
              mode="aspectFit"
              class="hero-image"
              data-index="{{index}}"
              bindtap="openImageViewer"
              bindlongpress="onImageLongPress"
              bindload="onImageLoad"
              binderror="onImageError"
              lazy-load="true"
            />
          </swiper-item>
        </block>
      </swiper>

      <!-- å›¾ç‰‡æµ®å±‚ä¿¡æ¯ -->
      <view class="hero-overlay">
        <!-- å›¾ç‰‡è®¡æ•° -->
        <view class="image-counter" wx:if="{{work.images.length > 1}}">
          <text>{{currentImageIndex + 1}} / {{work.images.length}}</text>
        </view>

        <!-- å¿«æ·æ“ä½œ -->
        <view class="quick-actions">
          <button class="quick-btn" bindtap="enterFullscreen">
            <text class="iconfont icon-search"></text>
            <text>å…¨å±</text>
          </button>
          <button class="quick-btn {{work.is_favorite ? 'active' : ''}}" bindtap="toggleFavorite">
            <text class="iconfont {{work.is_favorite ? 'icon-heart-fill' : 'icon-heart'}}"></text>
            <text>{{work.is_favorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
          </button>
          <button class="quick-btn" bindtap="saveToMemory">
            <text class="iconfont icon-camera"></text>
            <text>å­˜å›å¿†</text>
          </button>
        </view>
      </view>
    </view>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <view class="content-area">
      <!-- ä½œå“ä¿¡æ¯å¡ç‰‡ -->
      <view class="info-card card-hover">
        <view class="work-header">
          <view class="title-section">
            <view class="title-container">
              <text class="work-title" wx:if="{{!editingTitle}}" bindtap="startEditTitle">{{work.title || 'ç‚¹å‡»è®¾ç½®ä½œå“åç§°'}}</text>
              <input class="title-input" wx:else value="{{editingTitleValue}}" bindinput="onTitleInput" bindblur="finishEditTitle" bindconfirm="finishEditTitle" placeholder="è¯·è¾“å…¥ä½œå“åç§°" auto-focus="true" />
              <button class="edit-title-btn" wx:if="{{!editingTitle}}" bindtap="startEditTitle">
                <text class="iconfont icon-edit"></text>
              </button>
            </view>
            <view class="work-tags">
              <text class="tag primary">
                {{work.type === 'photography' ? 'AIæ‘„å½±' : 'AIè¯•è¡£'}}
              </text>
              <text class="tag {{work.status === 'completed' ? 'success' : 'warning'}}" wx:if="{{work.status}}">
                {{work.status === 'completed' ? 'å·²å®Œæˆ' : work.status}}
              </text>
            </view>
          </view>

          <view class="work-meta">
            <view class="meta-item">
              <text class="iconfont icon-time"></text>
              <text>{{formatTime(work.created_at)}}</text>
            </view>
            <view class="meta-item" wx:if="{{work.scene_name}}">
              <text class="iconfont icon-location"></text>
              <text>{{work.scene_name}}</text>
            </view>
          </view>
        </view>

        <!-- æ‘„å½±å¸ˆè¯´ï¼ˆAIè¿”å›çš„æ–‡å­—æè¿°ï¼‰ -->
        <view wx:if="{{work.ai_description}}" class="ai-section">
          <view class="section-header">
            <view class="header-left">
              <text class="iconfont icon-robot"></text>
              <text>æ‘„å½±å¸ˆè¯´</text>
            </view>
            <button class="copy-btn" bindtap="copyAIDescription">
              <text class="iconfont icon-copy"></text>
              <text>å¤åˆ¶</text>
            </button>
          </view>
          <view class="ai-content">
            <text>{{work.ai_description}}</text>
          </view>
        </view>

        <!-- åŸå›¾å¯¹æ¯” -->
        <view wx:if="{{originalImagesUrls && originalImagesUrls.length > 0}}" class="original-images-section">
          <view class="section-header">
            <view class="header-left">
              <text class="iconfont icon-image"></text>
              <text>åŸå›¾å‚è€ƒ</text>
            </view>
            <text class="image-count">{{originalImagesUrls.length}}å¼ </text>
          </view>
          <view class="original-images-grid">
            <block wx:for="{{originalImagesUrls}}" wx:key="index">
              <view class="original-image-item" bindtap="previewOriginalImage" data-index="{{index}}">
                <image
                  src="{{item.url}}"
                  mode="aspectFill"
                  class="original-image"
                  lazy-load="true"
                />
                <view class="image-type-tag" wx:if="{{item.typeLabel}}">{{item.typeLabel}}</view>
              </view>
            </block>
          </view>
        </view>

        <!-- ç”Ÿæˆå‚æ•° -->
        <view wx:if="{{work.parameters}}" class="info-group">
          <view class="info-group-header" bindtap="toggleParams">
            <view class="info-group-title">
              <text class="iconfont icon-settings"></text>
              <text>ç”Ÿæˆå‚æ•°</text>
            </view>
            <view class="info-group-summary">
              <text wx:if="{{!showParams}}">ç‚¹å‡»æŸ¥çœ‹</text>
              <text class="iconfont {{showParams ? 'icon-up' : 'icon-down'}}"></text>
            </view>
          </view>
          <view wx:if="{{showParams}}" class="info-group-content">
            <view class="params-grid">
              <!-- æ‘„å½±å‚æ•° -->
              <block wx:if="{{work.type === 'photography'}}">
                <view class="param-chip" wx:if="{{work.parameters.gender}}">
                  <text class="param-label">æ€§åˆ«</text>
                  <text class="param-value">{{work.parameters.gender === 'female' ? 'å¥³æ€§' : 'ç”·æ€§'}}</text>
                </view>
                <view class="param-chip" wx:if="{{work.parameters.age}}">
                  <text class="param-label">å¹´é¾„</text>
                  <text class="param-value">{{work.parameters.age}}å²</text>
                </view>
                <view class="param-chip" wx:if="{{work.parameters.height}}">
                  <text class="param-label">èº«é«˜</text>
                  <text class="param-value">{{work.parameters.height}}cm</text>
                </view>
                <view class="param-chip" wx:if="{{work.parameters.nationality}}">
                  <text class="param-label">ç±»å‹</text>
                  <text class="param-value">{{work.parameters.nationality}}</text>
                </view>
                <view class="param-chip" wx:if="{{work.parameters.location}}">
                  <text class="param-label">åœºæ™¯</text>
                  <text class="param-value">{{work.parameters.location}}</text>
                </view>
              </block>

              <!-- è¯•è¡£å‚æ•° -->
              <block wx:elif="{{work.type === 'fitting'}}">
                <view class="param-chip" wx:if="{{work.parameters.overall_clothing_material}}">
                  <text class="param-label">æè´¨</text>
                  <text class="param-value">{{work.parameters.overall_clothing_material}}</text>
                </view>
                <view class="param-chip" wx:if="{{work.parameters.pose_adjustment}}">
                  <text class="param-label">å§¿æ€</text>
                  <text class="param-value">{{work.parameters.pose_adjustment}}</text>
                </view>
              </block>
            </view>
          </view>
        </view>

        <!-- æŠ€æœ¯ä¿¡æ¯ï¼ˆç®€åŒ–ï¼‰ -->
        <view class="info-group" wx:if="{{work.images[0].width || work.api_provider}}">
          <view class="info-group-header" bindtap="toggleTechInfo">
            <view class="info-group-title">
              <text class="iconfont icon-info"></text>
              <text>æŠ€æœ¯ä¿¡æ¯</text>
            </view>
            <view class="info-group-summary">
              <text wx:if="{{!showTechExpanded}}">{{work.images[0].width}}Ã—{{work.images[0].height}}</text>
              <text class="iconfont {{showTechExpanded ? 'icon-up' : 'icon-down'}}"></text>
            </view>
          </view>
          <view wx:if="{{showTechExpanded}}" class="info-group-content">
            <view class="tech-grid">
              <view class="tech-chip" wx:if="{{work.images[0].width}}">
                <text class="tech-label">åˆ†è¾¨ç‡</text>
                <text class="tech-value">{{work.images[0].width}}Ã—{{work.images[0].height}}</text>
              </view>
              <view class="tech-chip" wx:if="{{work.api_provider}}">
                <text class="tech-label">AIå¼•æ“</text>
                <text class="tech-value">{{work.api_provider}}</text>
              </view>
              <view class="tech-chip" wx:if="{{work.generation_time}}">
                <text class="tech-label">ç”Ÿæˆæ—¶é—´</text>
                <text class="tech-value">{{work.generation_time}}ç§’</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ä¸»è¦æ“ä½œæŒ‰é’® -->
    <view class="action-area">
      <view class="primary-actions">
        <button class="action-btn primary btn-enhanced btn-ripple" bindtap="regenerate">
          <text class="iconfont icon-refresh"></text>
          <text>åŒæ¬¾å†ç”Ÿ</text>
        </button>

        <button class="action-btn highlight btn-enhanced btn-shine" bindtap="showPoseVariationModal">
          <text class="iconfont icon-camera"></text>
          <text>æ¢ä¸ªå§¿åŠ¿å†æ‹</text>
        </button>

        <button class="action-btn secondary btn-enhanced btn-ripple" bindtap="saveToAlbum">
          <text class="iconfont icon-download"></text>
          <text>ä¿å­˜å›¾ç‰‡</text>
        </button>
      </view>

      <view class="secondary-actions">
        <button class="action-btn ghost btn-enhanced" open-type="share">
          <text class="iconfont icon-share"></text>
          <text>åˆ†äº«</text>
        </button>

        <button class="action-btn ghost btn-enhanced" bindtap="generateSharePoster">
          <text class="iconfont icon-image"></text>
          <text>ç”Ÿæˆæµ·æŠ¥</text>
        </button>

        <button class="action-btn ghost btn-enhanced" bindtap="submitFeedback">
          <text class="iconfont icon-edit"></text>
          <text>åé¦ˆ</text>
        </button>

        <button class="action-btn danger" bindtap="deleteWork">
          <text class="iconfont icon-delete"></text>
          <text>åˆ é™¤</text>
        </button>
      </view>
    </view>

    <!-- å…¨å±å›¾ç‰‡æŸ¥çœ‹å™¨ -->
    <view class="image-viewer" wx:if="{{showImageViewer}}" bindtap="closeImageViewer">
      <view class="viewer-container" catchtap="stopPropagation">
        <swiper
          class="viewer-swiper"
          indicator-dots="{{imageViewerUrls.length > 1}}"
          indicator-color="rgba(255,255,255,0.5)"
          indicator-active-color="#fff"
          circular="{{imageViewerUrls.length > 1}}"
          current="{{currentImageIndex}}"
          bindchange="onImageChange"
        >
          <block wx:for="{{imageViewerUrls}}" wx:key="index">
            <swiper-item>
              <image
                src="{{item}}"
                mode="aspectFit"
                class="viewer-image"
                data-index="{{index}}"
                bindlongpress="onImageLongPress"
              />
            </swiper-item>
          </block>
        </swiper>

        <!-- å…³é—­æŒ‰é’® -->
        <button class="close-btn" bindtap="closeImageViewer">âœ•</button>
      </view>
    </view>

    <!-- å§¿åŠ¿è£‚å˜å¼¹çª— -->
    <view class="pose-variation-modal" wx:if="{{showPoseModal}}" bindtap="closePoseModal">
      <view class="modal-content" catchtap="stopPropagation">
        <view class="modal-header">
          <text class="modal-title">æ¢ä¸ªå§¿åŠ¿å†æ‹</text>
          <text class="modal-subtitle">å‘Šè¯‰æ‘„å½±å¸ˆä½ æƒ³è¦çš„å§¿åŠ¿æˆ–åŠ¨ä½œ</text>
        </view>

        <view class="modal-body">
          <!-- æ¨¡å¼é€‰æ‹© -->
          <view class="mode-selector">
            <view
              class="mode-option {{poseMode === 'ai' ? 'active' : ''}}"
              bindtap="selectPoseMode"
              data-mode="ai"
            >
              <text class="mode-icon">ğŸ¤–</text>
              <text class="mode-name">AIè£‚å˜</text>
            </view>
            <view
              class="mode-option {{poseMode === 'preset' ? 'active' : ''}}"
              bindtap="selectPoseMode"
              data-mode="preset"
            >
              <text class="mode-icon">â˜‘</text>
              <text class="mode-name">é€‰æ‹©å§¿åŠ¿</text>
            </view>
            <view
              class="mode-option {{poseMode === 'custom' ? 'active' : ''}}"
              bindtap="selectPoseMode"
              data-mode="custom"
            >
              <text class="mode-icon">âœ</text>
              <text class="mode-name">è‡ªå®šä¹‰</text>
            </view>
          </view>

          <!-- AIå§¿åŠ¿è£‚å˜ -->
          <view class="ai-pose-variation" wx:if="{{poseMode === 'ai'}}">
            <view class="ai-intro">
              <text class="intro-icon">ğŸ’¡</text>
              <text class="intro-text">åŸºäºç¬¬ä¸€æ¬¡ç”Ÿæˆçš„æè¿°ï¼ŒAIä¸ºæ‚¨æ™ºèƒ½ç”Ÿæˆå§¿åŠ¿å˜ä½“</text>
            </view>

            <!-- AIç”ŸæˆåŠ¨ç”»ï¼ˆ30ç§’ï¼‰ -->
            <view wx:if="{{aiLoading}}" class="ai-generating-animation">
              <view class="animation-content">
                <!-- æ—‹è½¬ç›¸æœºå›¾æ ‡ -->
                <view class="camera-icon rotating">
                  <text class="icon">ğŸ“¸</text>
                </view>

                <!-- æ ‡é¢˜ -->
                <view class="loading-title">AIè®¾è®¡åŠ¨ä½œä¸­...</view>

                <!-- è¿›åº¦æ¡ -->
                <view class="progress-container">
                  <view class="progress-bar">
                    <view class="progress-fill"></view>
                  </view>
                  <text class="progress-text">é¢„è®¡éœ€è¦ 30 ç§’</text>
                </view>

                <!-- åŠ¨æ€æç¤ºæ–‡å­— -->
                <view class="loading-tips">
                  <text class="tip-icon">ğŸ’¡</text>
                  <text class="tip-text">{{aiLoadingTip}}</text>
                </view>

                <!-- è£…é¥°å…ƒç´  -->
                <view class="decoration-dots">
                  <view class="dot dot-1"></view>
                  <view class="dot dot-2"></view>
                  <view class="dot dot-3"></view>
                </view>
              </view>
            </view>

            <scroll-view wx:elif="{{aiGeneratedPoses.length > 0}}" scroll-y class="pose-scroll">
              <view
                class="pose-item {{selectedAIPose === item ? 'selected' : ''}}"
                wx:for="{{aiGeneratedPoses}}"
                wx:key="index"
                bindtap="selectAIPose"
                data-pose="{{item}}"
              >
                <text class="pose-number">{{index + 1}}</text>
                <view class="pose-info">
                  <text class="pose-desc">{{item}}</text>
                </view>
                <text class="iconfont icon-check" wx:if="{{selectedAIPose === item}}"></text>
              </view>
            </scroll-view>

            <view wx:else class="empty-poses">
              <text class="empty-icon">ğŸ“¸</text>
              <text class="empty-text">æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆå§¿åŠ¿å˜ä½“...</text>
            </view>
          </view>

          <!-- é¢„è®¾å§¿åŠ¿åˆ—è¡¨ -->
          <view class="pose-presets" wx:if="{{poseMode === 'preset'}}">
            <view wx:if="{{loadingPoses}}" class="loading-poses">
              <text>åŠ è½½å§¿åŠ¿åˆ—è¡¨ä¸­...</text>
            </view>
            <scroll-view wx:else scroll-y class="pose-scroll">
              <view
                class="pose-item {{selectedPoseId === item._id ? 'selected' : ''}}"
                wx:for="{{posePresets}}"
                wx:key="_id"
                bindtap="selectPose"
                data-id="{{item._id}}"
                data-name="{{item.name}}"
              >
                <text class="pose-emoji">{{item.icon_emoji}}</text>
                <view class="pose-info">
                  <text class="pose-name">{{item.name}}</text>
                  <text class="pose-desc">{{item.description}}</text>
                </view>
                <text class="iconfont icon-check" wx:if="{{selectedPoseId === item._id}}"></text>
              </view>
            </scroll-view>
          </view>

          <!-- è‡ªå®šä¹‰è¾“å…¥ -->
          <view class="custom-input" wx:if="{{poseMode === 'custom'}}">
            <textarea
              class="pose-textarea"
              placeholder="å‘Šè¯‰æ‘„å½±å¸ˆä½ æƒ³è¦çš„è§’åº¦æˆ–åŠ¨ä½œï¼Œä¾‹å¦‚ï¼š&#10;&#10;ä¾§é¢ç‰¹å†™ã€èµ°è¿‘é•œå¤´ã€èƒŒå½±ã€45åº¦ä»°æ‹...&#10;&#10;ç•™ç©ºåˆ™ç”±æ‘„å½±å¸ˆæ ¹æ®åœºæ™¯è‡ªåŠ¨è®¾è®¡ä¸‹ä¸€ä¸ªåŠ¨ä½œ"
              value="{{customPoseDescription}}"
              bindinput="onCustomPoseInput"
              maxlength="500"
              show-confirm-bar="{{false}}"
            />
            <text class="char-count">{{customPoseDescription.length}}/500</text>
          </view>

          <!-- ç§¯åˆ†æç¤º -->
          <view class="credit-info">
            <text class="iconfont icon-coin"></text>
            <text>æ¶ˆè€— 1 ç§¯åˆ†</text>
          </view>
        </view>

        <view class="modal-footer">
          <button class="modal-btn cancel" bindtap="closePoseModal">å–æ¶ˆ</button>
          <button class="modal-btn confirm" bindtap="confirmPoseVariation" disabled="{{!canConfirm}}">
            å¼€å§‹æ‹æ‘„
          </button>
        </view>
      </view>
    </view>
  </block>
</view>